# mill.yml - The main loop
#
# Runs every 5 minutes. Checks if another run is in progress, if so exits.
# Runs Claude Code with the prompt from .mill/PROMPT.md, then commits any changes.
#
# To stop: use mill-control workflow to disable
# To resume: use mill-control workflow to enable

name: mill

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Check for running workflows
        uses: actions/github-script@v7
        id: check
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'mill.yml',
              status: 'in_progress',
            });
            const otherRuns = runs.data.workflow_runs.filter(r => r.id !== context.runId);
            if (otherRuns.length > 0) {
              console.log('Another run is in progress, exiting.');
              return 'skip';
            }
            return 'continue';
          result-encoding: string

      - name: Exit if another run in progress
        if: steps.check.outputs.result == 'skip'
        run: exit 0

      - name: Checkout
        if: steps.check.outputs.result == 'continue'
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}
          persist-credentials: true

      - name: Setup git
        if: steps.check.outputs.result == 'continue'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install Claude Code
        if: steps.check.outputs.result == 'continue'
        run: npm install -g @anthropic-ai/claude-code

      - name: Run agent
        if: steps.check.outputs.result == 'continue'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ github.token }}
        run: |
          PROMPT=$(cat .mill/PROMPT.md)
          MODEL=$(jq -r '.model // "opus"' .mill/config.json)
          BUDGET=$(jq -r '.maxBudgetPerRun // 10' .mill/config.json)
          claude -p "$PROMPT" \
            --dangerously-skip-permissions \
            --model "$MODEL" \
            --max-budget-usd "$BUDGET" \
            --no-session-persistence
